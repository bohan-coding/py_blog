{% extends "movies/base.html" %}

{% block page_title %}电影列表{% endblock %}

{% block movie_content %}
<div class="page-header mb-4">
    <h1 class="page-title">电影清单</h1>
</div>

<!-- 筛选和排序 -->
<div class="row mb-4">
    <div class="col-md-9">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <select name="category" class="form-select">
                    <option value="">全部分类</option>
                    {% for category in categories %}
                        {% if category[0] %}
                        <option value="{{ category[0] }}" {% if category[0] == current_category %}selected{% endif %}>{{ category[0] }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select name="genre" class="form-select">
                    <option value="">全部类型</option>
                    {% for genre in genres %}
                        {% if genre[0] %}
                        <option value="{{ genre[0] }}" {% if genre[0] == current_genre %}selected{% endif %}>{{ genre[0] }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select name="sort_by" class="form-select">
                    <option value="created_at" {% if current_sort == 'created_at' %}selected{% endif %}>最新添加</option>
                    <option value="rating" {% if current_sort == 'rating' %}selected{% endif %}>评分排序</option>
                    <option value="year" {% if current_sort == 'year' %}selected{% endif %}>年份排序</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary">筛选</button>
            </div>
        </form>
    </div>
</div>

<!-- 电影列表 -->
{% if movies.items %}
<div class="row">
    {% for movie in movies.items %}
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <div class="card h-100">
            {% if movie.image_url %}
            <img src="{{ movie.image_url }}" class="card-img-top" alt="{{ movie.title }}" style="height: 250px; object-fit: cover;">
            {% else %}
            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 250px;">
                <i class="fas fa-film fa-3x text-muted"></i>
            </div>
            {% endif %}
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ movie.title }}</h5>
                <p class="card-text flex-grow-1">
                    <small class="text-muted">{{ movie.year }} | {{ movie.category }}</small><br>
                    {% if movie.genre %}
                    <small class="text-muted">{{ movie.genre }}</small>
                    {% endif %}
                </p>
                <div class="mt-auto">
                    {% if movie.rating %}
                    <div class="mb-2">
                        <span class="badge bg-warning text-dark">评分: {{ movie.rating }}</span>
                    </div>
                    {% endif %}
                    <a href="{{ url_for('movies.detail', id=movie.id) }}" class="btn btn-primary">查看详情</a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- 分页 -->
{% if movies.pages > 1 %}
<nav aria-label="电影列表分页">
    <ul class="pagination justify-content-center">
        {% if movies.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('movies.movie_list', page=movies.prev_num, category=current_category, genre=current_genre, sort_by=current_sort) }}">上一页</a>
        </li>
        {% endif %}
        
        {% for page_num in movies.iter_pages() %}
            {% if page_num %}
                {% if page_num != movies.page %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('movies.movie_list', page=page_num, category=current_category, genre=current_genre, sort_by=current_sort) }}">{{ page_num }}</a>
                </li>
                {% else %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% endif %}
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">…</span>
            </li>
            {% endif %}
        {% endfor %}
        
        {% if movies.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('movies.movie_list', page=movies.next_num, category=current_category, genre=current_genre, sort_by=current_sort) }}">下一页</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5">
    <i class="fas fa-film fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">暂无电影数据</h4>
    <p class="text-muted">请稍后查看或联系管理员更新数据</p>
</div>
{% endif %}
{% endblock %}